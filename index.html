<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Grocery Price Manager</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family: Arial, sans-serif;
  background:#f5f5f5;
  padding:20px;
}
.container{
  max-width:480px;
  margin:auto;
  background:#fff;
  border-radius:8px;
  box-shadow:0 0 10px rgba(0,0,0,.1);
  padding:20px;
}
label{font-weight:bold;display:block;margin-top:10px}
input{
  width:100%;
  height:40px;
  padding:8px;
  margin-top:5px;
  border-radius:4px;
  border:1px solid #ccc;
}
button{
  border:none;
  border-radius:4px;
  cursor:pointer;
}
.primary-btn{
  width:100%;
  height:36px;
  font-size:14px;
  margin-top:8px;
}
.add-item-btn{background:#6f42c1;color:#fff}
.add-dealer-btn{background:#28a745;color:#fff}
.cancel-btn{background:#6c757d;color:#fff}
.edit-btn{background:#007bff;color:#fff;height:28px;font-size:12px}
.delete-btn{background:#dc3545;color:#fff;height:28px;font-size:12px}

.suggestions{
  border:1px solid #ccc;
  border-top:none;
  max-height:150px;
  overflow-y:auto;
}
.suggestions div{
  padding:8px;
  cursor:pointer;
}
.suggestions div:hover,
.suggestions div.active{
  background:#007bff;
  color:#fff;
}

.info-box{
  margin-top:15px;
  padding:12px;
  background:#f8f9fa;
  border-radius:6px;
}
.dealer-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:#fff;
  padding:6px;
  margin-top:6px;
  border-radius:4px;
}
.hidden{display:none}
</style>
</head>

<body>

<div class="container">

  <!-- ITEM SEARCH -->
  <label>Item</label>
  <input
    id="itemInput"
    placeholder="Type or select item..."
    oninput="filterItems()"
    onkeydown="handleKeys(event)"
  >
  <div id="suggestions" class="suggestions"></div>

  <!-- ACTION BUTTONS -->
  <div id="actionButtons">
    <button class="primary-btn add-item-btn" onclick="showAddItem()">➕ Add Item</button>
    <button class="primary-btn add-dealer-btn" onclick="showAddDealer()">➕ Add Dealer</button>
  </div>

  <!-- ADD ITEM -->
  <div id="addItemBox" class="info-box hidden">
    <label>Item Name</label>
    <input id="newItemName">

    <label>Dealer</label>
    <input id="newItemDealer" list="dealerMaster">
    <datalist id="dealerMaster"></datalist>

    <label>Price</label>
    <input id="newItemPrice" type="number">

    <button class="primary-btn add-item-btn" onclick="addItem()">Save Item</button>
    <button class="primary-btn cancel-btn" onclick="cancelForms()">Cancel</button>
  </div>

  <!-- ADD DEALER -->
  <div id="addDealerBox" class="info-box hidden">
    <label>Dealer</label>
    <input id="dealerName" list="dealerMaster">

    <label>Price</label>
    <input id="dealerPrice" type="number">

    <button class="primary-btn add-dealer-btn" onclick="addDealer()">Save Dealer</button>
    <button class="primary-btn cancel-btn" onclick="cancelForms()">Cancel</button>
  </div>

  <!-- DEALER LIST -->
  <div id="details" class="info-box hidden">
    <div id="dealerList"></div>
  </div>

</div>

<script>
/* ================= CONFIG ================= */
const API_URL = "https://script.google.com/macros/s/AKfycbzRt_ad2rXgZNVO4_Nlumm8EAxN7jcG7gG1y0yKEec7WXnws68ygcAqrhCjRzcmdWzl/exec";
const API_KEY = "9848o22338B!";

/* ================= STATE ================= */
let groceries = {};
let filteredItems = [];
let activeIndex = -1;
let selectedItem = "";

/* ================= LOAD ================= */
window.onload = () => {
  fetch(`${API_URL}?key=${API_KEY}`)
    .then(r => r.json())
    .then(data => {
      groceries = data || {};
      populateDealerMaster();
    });
};

/* ================= DEALER MASTER ================= */
function populateDealerMaster(){
  const set = new Set();
  Object.values(groceries).forEach(arr=>{
    arr.forEach(d=>set.add(d.dealer));
  });
  dealerMaster.innerHTML="";
  [...set].sort().forEach(name=>{
    const o=document.createElement("option");
    o.value=name;
    dealerMaster.appendChild(o);
  });
}

/* ================= ITEM AUTOCOMPLETE ================= */
function filterItems(){
  if(addItemBox.classList.contains("hidden")===false) return;
  if(addDealerBox.classList.contains("hidden")===false) return;

  const val = itemInput.value.toLowerCase();
  suggestions.innerHTML="";
  filteredItems=[];
  activeIndex=-1;
  if(!val) return;

  filteredItems = Object.keys(groceries)
    .filter(i => i.toLowerCase().includes(val));

  filteredItems.forEach(i=>{
    const d=document.createElement("div");
    d.textContent=i;
    d.onclick=()=>selectItem(i);
    suggestions.appendChild(d);
  });
}
function handleKeys(e){
  if(!filteredItems.length) return;
  if(e.key==="ArrowDown"){e.preventDefault();activeIndex=(activeIndex+1)%filteredItems.length;highlight();}
  else if(e.key==="ArrowUp"){e.preventDefault();activeIndex=(activeIndex-1+filteredItems.length)%filteredItems.length;highlight();}
  else if(e.key==="Enter"||e.key==="Tab"){e.preventDefault();selectItem(filteredItems[activeIndex===-1?0:activeIndex]);}
}
function highlight(){
  [...suggestions.children].forEach((el,i)=>el.classList.toggle("active",i===activeIndex));
}

/* ================= SELECT ITEM ================= */
function selectItem(item){
  selectedItem=item;
  itemInput.value=item;
  suggestions.innerHTML="";
  details.classList.remove("hidden");

  dealerList.innerHTML="";
  (groceries[item]||[]).forEach(d=>{
    dealerList.innerHTML+=`
      <div class="dealer-row">
        <div><b>${d.dealer}</b> – ₹${d.price}</div>
      </div>`;
  });
}

/* ================= ADD ITEM ================= */
function showAddItem(){
  actionButtons.classList.add("hidden");
  suggestions.classList.add("hidden");
  addItemBox.classList.remove("hidden");
}
function addItem(){
  const item=newItemName.value.trim();
  const dealer=newItemDealer.value.trim();
  const price=Number(newItemPrice.value);
  if(!item||!dealer||isNaN(price)) return;

  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({key:API_KEY,action:"add",item,dealer,price})
  }).then(()=>{
    groceries[item]=[{dealer,price,updated:Date.now()}];
    populateDealerMaster();
    cancelForms();
    selectItem(item);
  });
}

/* ================= ADD DEALER ================= */
function showAddDealer(){
  if(!selectedItem) return alert("Select item first");
  actionButtons.classList.add("hidden");
  suggestions.classList.add("hidden");
  addDealerBox.classList.remove("hidden");
}
function addDealer(){
  const dealer=dealerName.value.trim();
  const price=Number(dealerPrice.value);
  if(!dealer||isNaN(price)) return;

  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({key:API_KEY,action:"add",item:selectedItem,dealer,price})
  }).then(()=>{
    groceries[selectedItem].push({dealer,price,updated:Date.now()});
    populateDealerMaster();
    cancelForms();
    selectItem(selectedItem);
  });
}

/* ================= CANCEL ================= */
function cancelForms(){
  addItemBox.classList.add("hidden");
  addDealerBox.classList.add("hidden");
  actionButtons.classList.remove("hidden");
  suggestions.classList.remove("hidden");

  newItemName.value="";
  newItemDealer.value="";
  newItemPrice.value="";
  dealerName.value="";
  dealerPrice.value="";
}
</script>

</body>
</html>
