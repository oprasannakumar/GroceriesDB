<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Grocery Dealer Price Manager</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family: Arial, sans-serif;
  background:#f5f5f5;
  padding:20px;
}
.container{
  max-width:500px;
  margin:auto;
  background:#fff;
  border-radius:8px;
  box-shadow:0 0 10px rgba(0,0,0,.1);
  padding:20px;
}

label{font-weight:bold;margin-top:10px;display:block}
input{
  width:100%;
  height:40px;
  padding:8px;
  margin-top:5px;
  border-radius:4px;
  border:1px solid #ccc;
  box-sizing:border-box;
}

button{
  width:100%;
  height:42px;
  margin-top:10px;
  border:none;
  border-radius:4px;
  font-size:15px;
  cursor:pointer;
}

.add-btn{background:#28a745;color:#fff}
.edit-btn{background:#007bff;color:#fff}
.delete-btn{background:#dc3545;color:#fff}
.item-btn{background:#6f42c1;color:#fff}

.suggestions{
  border:1px solid #ccc;
  border-top:none;
  max-height:150px;
  overflow-y:auto;
}
.suggestions div{
  padding:8px;
  cursor:pointer;
}
.suggestions div:hover,
.suggestions div.active{
  background:#007bff;
  color:#fff;
}

.info-box{
  margin-top:15px;
  padding:12px;
  background:#f8f9fa;
  border-radius:6px;
}

.dealer-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:#fff;
  padding:6px;
  margin-top:6px;
  border-radius:4px;
}
.dealer-row button{
  width:auto;
  height:30px;
  font-size:13px;
  margin-left:5px;
}

.hidden{display:none}
hr{margin:15px 0}
</style>
</head>

<body>

<div class="container">

  <label>Search Item</label>
  <input
    id="itemInput"
    placeholder="Type item name..."
    oninput="filterItems()"
    onkeydown="handleKeys(event)"
  >
  <div id="suggestions" class="suggestions"></div>

  <!-- ADD ITEM -->
  <button class="item-btn" onclick="addNewItem()">‚ûï Add New Item</button>

  <div id="details" class="info-box hidden">
    <h3 id="itemTitle"></h3>

    <button class="delete-btn" onclick="deleteItem()">üóë Delete Item</button>

    <div id="dealerList"></div>

    <hr>

    <label>Add Dealer</label>
    <input id="dealerName" placeholder="Dealer name">
    <input id="dealerPrice" type="number" placeholder="Price">

    <button class="add-btn" onclick="addDealer()">‚ûï Add Dealer</button>
  </div>

</div>

<script>
/* ================= CONFIG ================= */
const API_URL =
"https://script.google.com/macros/s/AKfycbzRt_ad2rXgZNVO4_Nlumm8EAxN7jcG7gG1y0yKEec7WXnws68ygcAqrhCjRzcmdWzl/exec";
const API_KEY = "9848o22338B!";

/* ================= STATE ================= */
let groceries = {};
let filteredItems = [];
let activeIndex = -1;
let selectedItem = "";

/* ================= LOAD ================= */
window.onload = () => {
  fetch(`${API_URL}?key=${API_KEY}`)
    .then(r => r.text())
    .then(text => groceries = JSON.parse(text || "{}"))
    .catch(() => alert("Failed to load data"));
};

/* ================= AUTOCOMPLETE ================= */
function filterItems(){
  const val = itemInput.value.toLowerCase();
  suggestions.innerHTML="";
  filteredItems=[];
  activeIndex=-1;

  if(!val) return;

  filteredItems = Object.keys(groceries)
    .filter(i => i.toLowerCase().includes(val));

  filteredItems.forEach(i=>{
    const d=document.createElement("div");
    d.textContent=i;
    d.onclick=()=>selectItem(i);
    suggestions.appendChild(d);
  });
}

/* ================= KEYS ================= */
function handleKeys(e){
  if(!filteredItems.length) return;

  if(e.key==="ArrowDown"){
    e.preventDefault();
    activeIndex=(activeIndex+1)%filteredItems.length;
    highlight();
  }else if(e.key==="ArrowUp"){
    e.preventDefault();
    activeIndex=(activeIndex-1+filteredItems.length)%filteredItems.length;
    highlight();
  }else if(e.key==="Enter"||e.key==="Tab"){
    e.preventDefault();
    if(activeIndex===-1) activeIndex=0;
    selectItem(filteredItems[activeIndex]);
  }
}

function highlight(){
  [...suggestions.children].forEach((el,i)=>{
    el.classList.toggle("active",i===activeIndex);
  });
}

/* ================= SELECT ================= */
function selectItem(item){
  selectedItem = item;
  itemTitle.textContent = item;
  details.classList.remove("hidden");
  suggestions.innerHTML = "";

  dealerList.innerHTML = "";

  (groceries[item] || []).forEach(d => {
    const row = document.createElement("div");
    row.className = "dealer-row";

    row.innerHTML = `
      <div>
        <b>${d.dealer}</b> ‚Äì ‚Çπ${d.price}<br>
        <span style="font-size:12px;color:#666">
          Last updated: ${d.updated || "N/A"}
        </span>
      </div>
      <div>
        <button class="edit-btn" onclick="editDealer('${d.dealer}', ${d.price})">‚úèÔ∏è</button>
        <button class="delete-btn" onclick="deleteDealer('${d.dealer}')">üóë</button>
      </div>
    `;

    dealerList.appendChild(row);
  });
}

/* ================= ADD ITEM ================= */
function addNewItem(){
  const item = prompt("Enter item name:");
  if(!item || groceries[item]) return alert("Item exists");

  const dealer = prompt("Enter dealer name:");
  const price = Number(prompt("Enter price:"));
  if(!dealer || isNaN(price)) return;

  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      key:API_KEY,
      action:"add",
      item,
      dealer,
      price
    })
  }).then(()=>{
    groceries[item]=[{dealer,price}];
    selectItem(item);
  });
}

/* ================= DELETE ITEM ================= */
function deleteItem(){
  if(!confirm(`Delete item "${selectedItem}" and all dealers?`)) return;

  const dealers = groceries[selectedItem] || [];
  Promise.all(dealers.map(d =>
    fetch(API_URL,{
      method:"POST",
      body:JSON.stringify({
        key:API_KEY,
        action:"delete",
        item:selectedItem,
        dealer:d.dealer
      })
    })
  )).then(()=>{
    delete groceries[selectedItem];
    selectedItem="";
    details.classList.add("hidden");
    itemInput.value="";
  });
}

/* ================= ADD DEALER ================= */
function addDealer(){
  const dealer=dealerName.value.trim();
  const price=Number(dealerPrice.value);
  if(!dealer||isNaN(price)) return;

  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      key:API_KEY,
      action:"add",
      item:selectedItem,
      dealer,
      price
    })
  }).then(()=>{
    groceries[selectedItem].push({dealer,price});
    dealerName.value="";
    dealerPrice.value="";
    selectItem(selectedItem);
  });
}

/* ================= EDIT DEALER ================= */
function editDealer(dealer,oldPrice){
  const price=prompt("Update price:",oldPrice);
  if(!price||isNaN(price)) return;

  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      key:API_KEY,
      action:"update",
      item:selectedItem,
      dealer,
      price:Number(price)
    })
  }).then(()=>{
    groceries[selectedItem].forEach(d=>{
      if(d.dealer===dealer) d.price=Number(price);
    });
    selectItem(selectedItem);
  });
}

/* ================= DELETE DEALER ================= */
function deleteDealer(dealer){
  if(!confirm(`Delete dealer ${dealer}?`)) return;

  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      key:API_KEY,
      action:"delete",
      item:selectedItem,
      dealer
    })
  }).then(()=>{
    groceries[selectedItem]=groceries[selectedItem].filter(d=>d.dealer!==dealer);
    selectItem(selectedItem);
  });
}
</script>

</body>
</html>
