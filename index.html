<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Grocery Price Manager</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family:Arial, sans-serif;
  background:#f5f5f5;
  padding:20px;
}
.container{
  max-width:420px;
  margin:auto;
  background:#fff;
  border-radius:8px;
  box-shadow:0 0 10px rgba(0,0,0,.1);
  padding:20px;
}

label{
  font-weight:bold;
  display:block;
  margin-top:10px;
}
input{
  width:100%;
  height:40px;
  padding:8px;
  margin-top:5px;
  border-radius:4px;
  border:1px solid #ccc;
}

/* Buttons */
button{
  width:100%;
  height:42px;
  margin-top:12px;
  border:none;
  border-radius:4px;
  font-size:15px;
  cursor:pointer;
}
.edit-btn{background:#007bff;color:#fff;}
.update-btn{background:#28a745;color:#fff;}
.delete-btn{background:#dc3545;color:#fff;}
.add-btn{background:#ffc107;color:#000;}

/* Suggestions */
.suggestions{
  border:1px solid #ccc;
  border-top:none;
  max-height:150px;
  overflow-y:auto;
}
.suggestions div{
  padding:8px;
  cursor:pointer;
}
.suggestions div:hover,
.suggestions div.active{
  background:#007bff;
  color:#fff;
}

/* Info */
.info-box{
  margin-top:15px;
  padding:12px;
  background:#f8f9fa;
  border-radius:6px;
}
.price{
  font-size:22px;
  font-weight:bold;
}
.muted{
  color:#666;
  font-size:13px;
}
.hidden{display:none;}
</style>
</head>

<body>

<div class="container">

  <label>Search Grocery Item</label>
  <input
    type="text"
    id="itemInput"
    placeholder="Type item name..."
    oninput="filterItems()"
    onkeydown="handleKeys(event)"
  >
  <div id="suggestions" class="suggestions"></div>

  <div id="details" class="info-box hidden">

    <div class="price">‚Çπ <span id="currentPrice">0</span></div>
    <div class="muted">Last Price: ‚Çπ <span id="lastPrice">N/A</span></div>
    <div class="muted">Last Updated: <span id="lastUpdated">N/A</span></div>

    <!-- Edit section -->
    <div id="editSection" class="hidden">
      <label>Edit Price (‚Çπ)</label>
      <input type="number" id="priceInput">
      <button class="update-btn" onclick="updatePrice()">Update Latest Price</button>
    </div>

    <button class="edit-btn" id="editBtn" onclick="enableEdit()">‚úèÔ∏è Edit Price</button>
    <button class="delete-btn" onclick="deleteItem()">üóë Delete Item</button>
  </div>

  <button class="add-btn" onclick="addNewItem()">‚ûï Add New Item</button>

</div>

<script>
/* ================= BACKEND ================= */
const API_URL =
"https://script.google.com/macros/s/AKfycbwzdNYP5zU0X_1ZpLIw61XczqOYBeMDzdfccel3QaVGiJSswS-OYWRMg2mPOyL9Tn-q/exec";
const API_KEY = "9848o22338B!"; // <-- SAME key as Apps Script

/* ================= STATE ================= */
let groceries = {};
let selectedItem = "";
let filteredItems = [];
let activeIndex = -1;

/* ================= LOAD DATA ================= */
window.onload = () => {
   fetch(`${API_URL}?key=${API_KEY}`)
    .then(res => res.json())
    .then(data => groceries = data || {})
    .catch(err => {
      alert("Failed to load data from Google Sheets");
      console.error(err);
    });
};

/* ================= AUTOCOMPLETE ================= */
function filterItems(){
  const val = itemInput.value.toLowerCase();
  suggestions.innerHTML = "";
  filteredItems = [];
  activeIndex = -1;

  if(!val) return;

  filteredItems = Object.keys(groceries)
    .filter(i => i.toLowerCase().includes(val));

  filteredItems.forEach(i=>{
    const d = document.createElement("div");
    d.textContent = i;
    d.onclick = () => selectItem(i);
    suggestions.appendChild(d);
  });
}

/* ================= KEYBOARD ================= */
function handleKeys(e){
  if(filteredItems.length === 0) return;

  if(e.key === "ArrowDown"){
    e.preventDefault();
    activeIndex = (activeIndex + 1) % filteredItems.length;
    highlight();
  }
  else if(e.key === "ArrowUp"){
    e.preventDefault();
    activeIndex = (activeIndex - 1 + filteredItems.length) % filteredItems.length;
    highlight();
  }
  else if(e.key === "Enter" || e.key === "Tab"){
    e.preventDefault();
    if(activeIndex === -1) activeIndex = 0;
    selectItem(filteredItems[activeIndex]);
  }
}

function highlight(){
  [...suggestions.children].forEach((el,i)=>{
    el.classList.toggle("active", i === activeIndex);
  });
}

/* ================= SELECT ================= */
function selectItem(item){
  selectedItem = item;
  const g = groceries[item];

  itemInput.value = item;
  suggestions.innerHTML = "";
  filteredItems = [];
  activeIndex = -1;

  details.classList.remove("hidden");
  editSection.classList.add("hidden");
  editBtn.classList.remove("hidden");

  currentPrice.textContent = g.price;
  lastPrice.textContent = g.lastPrice ?? "N/A";
  lastUpdated.textContent = g.updated ?? "N/A";
}

/* ================= EDIT ================= */
function enableEdit(){
  priceInput.value = groceries[selectedItem].price;
  editSection.classList.remove("hidden");
  editBtn.classList.add("hidden");
}

/* ================= UPDATE ================= */
function updatePrice(){
  const val = Number(priceInput.value);
  if(isNaN(val)) return;

  fetch(API_URL,{
    method:"POST",
    body: JSON.stringify({
      key: API_KEY,
      action:"update",
      item:selectedItem,
      price:val
    })
  }).then(()=>{
    groceries[selectedItem].lastPrice = groceries[selectedItem].price;
    groceries[selectedItem].price = val;
    groceries[selectedItem].updated = new Date().toLocaleString();
    selectItem(selectedItem);
  });
}

/* ================= ADD ================= */
function addNewItem(){
  const name = prompt("Enter new item name:");
  if(!name || groceries[name]) return;

  const price = prompt("Enter initial price:");
  if(!price || isNaN(price)) return;

  fetch(API_URL,{
    method:"POST",
    body: JSON.stringify({
      key: API_KEY,
      action:"add",
      item:name,
      price:Number(price)
    })
  }).then(()=>{
    groceries[name] = {
      price:Number(price),
      lastPrice:null,
      updated:new Date().toLocaleString()
    };
    selectItem(name);
  });
}

/* ================= DELETE ================= */
function deleteItem(){
  if(!confirm(`Delete "${selectedItem}" permanently?`)) return;

  fetch(API_URL,{
    method:"POST",
    body: JSON.stringify({
      key: API_KEY,
      action:"delete",
      item:selectedItem
    })
  }).then(()=>{
    delete groceries[selectedItem];
    selectedItem="";
    itemInput.value="";
    details.classList.add("hidden");
  });
}
</script>

</body>
</html>
